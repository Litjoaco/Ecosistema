{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - EcosistemaLA</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        header {
            background: linear-gradient(to right, #8EE000, #0096A7);
            padding: 10px 20px;
            color: white;
        }
        header img {
            height: 50px;
        }
        .table-responsive {
            margin-top: 2rem;
        }
        .table-container {
            max-height: 60vh; 
            overflow-y: auto;
        }
        .user-photo {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
        }
    </style>
</head>
<body>
<header class="d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
        <img src="{% static 'img/logo.jpg' %}" class="img-fluid rounded me-2" alt="Logo EcosistemaLA" style="height:50px;">
        <div>
            <span class="fw-bold fs-5 d-block">EcosistemaLA</span>
            <small>Panel de Administración</small>
        </div>
    </div>
    <div>
        <a href="{% url 'panel-admin:panel_admin' %}" class="btn btn-outline-light">Volver al Panel</a>
    </div>
</header>

<main class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Gestión de Usuarios</h1>
    </div>

    <!-- Filtros y Búsqueda -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form id="search-filter-form" class="row g-3 align-items-end" onsubmit="return false;" data-ajax-url="{% url 'panel-admin:buscar_usuarios_ajax' %}">
                <div class="col-md-5">
                    <label for="q" class="form-label">Buscar Usuario</label>
                    <input type="text" name="q" id="q" class="form-control" placeholder="Nombre, email, RUT..." value="{{ query }}">
                </div>
                <div class="col-md-4">
                    <label for="rubro" class="form-label">Filtrar por Rubro</label>
                    <select name="rubro" id="rubro" class="form-select">
                        <option value="">Todos los rubros</option>
                        {% for rubro in rubros %}
                            <option value="{{ rubro }}" {% if rubro == rubro_filter %}selected{% endif %}>{{ rubro }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex">
                    <button type="button" id="search-button" class="btn btn-primary w-100 me-2"><i class="bi bi-search me-1"></i> Buscar</button>
                    <a href="{% url 'panel-admin:gestion_usuarios' %}" class="btn btn-secondary w-100"><i class="bi bi-x-lg"></i></a>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card shadow">
        <div class="card-body">
            <div class="table-responsive table-container">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">Foto</th>
                            <th scope="col">Nombre Completo</th>
                            <th scope="col">Email</th>
                            <th scope="col">RUT</th>
                            <th scope="col">Rubro</th>
                            <th scope="col">Teléfono</th>
                            <th scope="col" class="text-center">Asistencias</th>
                            <th scope="col">Admin</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for usuario in usuarios %}
                        <tr>
                            <td>
                                {% if usuario.foto %}
                                    <img src="{{ usuario.foto.url }}" alt="Foto de {{ usuario.nombre }}" class="user-photo">
                                {% else %}
                                    <img src="{% static 'img/person.jpg' %}" alt="Sin foto" class="user-photo">
                                {% endif %}
                            </td>
                            <td>{{ usuario.nombre }} {{ usuario.apellido }}</td>
                            <td>{{ usuario.email }}</td>
                            <td>{{ usuario.rut }}</td>
                            <td>{{ usuario.get_rubro_real_display }}</td>
                            <td>{{ usuario.telefono }}</td>
                            <td class="text-center">
                                <span class="badge bg-primary rounded-pill">{{ usuario.cantidad_asistencias }}</span>
                            </td>
                            <td>{% if usuario.es_admin %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                            <td>
                                <!-- El botón de editar es visible para admin y ayudante -->
                                <a href="{% url 'panel-admin:editar_usuario_admin' usuario.id %}" class="btn btn-warning btn-sm"><i class="bi bi-pencil-square"></i></a>
                                <!-- El botón de eliminar solo es visible para el admin -->
                                {% if usuario_actual.es_admin and usuario.id != request.session.usuario_id %}
                                    <form action="{% url 'panel-admin:eliminar_usuario' usuario.id %}" method="POST" class="d-inline delete-form">
                                        {% csrf_token %}
                                        <button type="button" class="btn btn-danger btn-sm delete-btn" data-nombre="{{ usuario.nombre }} {{ usuario.apellido }}">
                                            <i class="bi bi-trash3-fill"></i>
                                        </button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not usuarios %}
                        <tr>
                            <td colspan="9" class="text-center text-muted p-4">No se encontraron usuarios con los filtros aplicados.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- Pasamos de forma segura el estado de admin a Javascript -->
{{ usuario_actual.es_admin|json_script:"is-current-user-admin" }}

<script src="{% static 'js/sweetalert2.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('q');
    const rubroFilter = document.getElementById('rubro');
    const userTableBody = document.querySelector('table tbody');
    const searchForm = document.getElementById('search-filter-form');
    const deleteFormSelector = '.delete-form';
    const deleteBtnSelector = '.delete-btn';
    const csrfToken = '{{ csrf_token }}';
    const searchButton = document.getElementById('search-button');
    const currentAdminId = '{{ request.session.usuario_id }}';

    let debounceTimer;
    function attachDeleteEventListeners() {
        document.querySelectorAll(deleteBtnSelector).forEach(button => {
            // Evita duplicar listeners si ya existe uno
            if (button.dataset.listenerAttached) return;

            button.addEventListener('click', function(event) {
                event.preventDefault();
                const form = this.closest(deleteFormSelector);
                const userName = this.dataset.nombre;

                Swal.fire({
                    title: `¿Estás seguro de eliminar a ${userName}?`,
                    text: "¡No podrás revertir esta acción!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, ¡eliminar!',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });
            button.dataset.listenerAttached = 'true';
        });
    }

    function fetchUsers() {
        const query = searchInput.value;
        const rubro = rubroFilter.value;
        const baseUrl = searchForm.dataset.ajaxUrl;
        const url = `${baseUrl}?q=${encodeURIComponent(query)}&rubro=${encodeURIComponent(rubro)}`;

        // Mostrar estado de carga en el botón
        searchButton.disabled = true;
        searchButton.innerHTML = `<i class="bi bi-hourglass-split me-1"></i> Buscando...`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                updateTable(data.usuarios);
            })
            .catch(error => console.error('Error fetching users:', error))
            .finally(() => {
                // Restaurar el botón
                searchButton.disabled = false;
                searchButton.innerHTML = `<i class="bi bi-search me-1"></i> Buscar`;
            });
    }

    function updateTable(usuarios) {
        userTableBody.innerHTML = ''; // Limpiar la tabla

        if (usuarios.length === 0) {
            userTableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted p-4">No se encontraron usuarios con los filtros aplicados.</td>
                </tr>
            `;
            return;
        }

        usuarios.forEach(usuario => {
            const adminIcon = usuario.es_admin 
                ? '<i class="bi bi-check-circle-fill text-success"></i>' 
                : '<i class="bi bi-x-circle-fill text-danger"></i>';

            // Solo se genera el botón de eliminar si el usuario actual es admin
            const isCurrentUserAdmin = JSON.parse(document.getElementById('is-current-user-admin').textContent);
            const deleteButton = isCurrentUserAdmin && usuario.id != currentAdminId
                ? `<form action="/panel-admin/usuarios/eliminar/${usuario.id}/" method="POST" class="d-inline delete-form"> \
                       <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}"> \
                       <button type="button" class="btn btn-danger btn-sm delete-btn" data-nombre="${usuario.nombre} ${usuario.apellido}"> \
                           <i class="bi bi-trash3-fill"></i> \
                       </button> \
                   </form>`
                : '';

            const row = `
                <tr>
                    <td><img src="${usuario.foto_url}" alt="Foto de ${usuario.nombre}" class="user-photo"></td>
                    <td>${usuario.nombre} ${usuario.apellido}</td>
                    <td>${usuario.email}</td>
                    <td>${usuario.rut}</td>
                    <td>${usuario.rubro}</td>
                    <td>${usuario.telefono}</td>
                    <td class="text-center"><span class="badge bg-primary rounded-pill">${usuario.cantidad_asistencias}</span></td>
                    <td>${adminIcon}</td>
                    <td class="text-nowrap">
                        <a href="/panel-admin/usuarios/editar/${usuario.id}/" class="btn btn-warning btn-sm"><i class="bi bi-pencil-square"></i></a>
                        ${deleteButton}
                    </td>
                </tr>
            `;
            userTableBody.insertAdjacentHTML('beforeend', row);
        });
        // Volver a asociar los eventos a los nuevos botones de eliminar
        attachDeleteEventListeners();
    }

    // Event listeners para la búsqueda en tiempo real
    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(fetchUsers, 300); // Espera 300ms después de la última tecla
    });
    searchButton.addEventListener('click', fetchUsers); // También permite búsqueda con el botón
    rubroFilter.addEventListener('change', fetchUsers);

    // Asocia los eventos a los botones de eliminar que cargan inicialmente
    attachDeleteEventListeners();
});
</script>
</body>
</html>